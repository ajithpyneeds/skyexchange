var CDN_TYPE={_WANGSU:"wansu",_GRIFFINMAS:"griffinmas",_AKAMAI:"akamai",_ERROR:-999},StreamPlayer=function(e,f,d){this.Version="v 020.06.30.01T";this.HLSObj=null;this.debug=f?f:!1;this.isMonitor=d?d:!1;this.options=e?e:{};console.log("Player Version: "+this.Version);this.lastSoundState=this.playState=null;this.lastclientTime=this.lastBufferd=this.lastCurrent=0;this.lastbase="";this.chkPlayBackTimes=this.chkBasetimes=this.chkLoadErrorTimes=this.chkSeekTimes=this.chkReadyStateTimes=this.chkBufferdTimes=this.chkCurrentTimes=0;this.chkBase="";this.hlsSupport=Hls.isSupported();this.iOS=!!navigator.platform&&/iPad|iPhone|iPod/.test(navigator.platform);this.userAgent=navigator.userAgent;this.linePart=0;this.m3u8Url=this.errDetails="";this.delayTime=this.currentTime=this.readyState=this.bufferTime=0;this.varObj={};this.varObj.maxMaxBufferLength=500;this.varObj.maxBufferSize=50000000;this.varObj.fragLoadingMaxRetry=1;this.varObj.manifestLoadingMaxRetry=1;this.varObj.levelLoadingMaxRetry=0;this.varObj.liveSyncDurationCount=3;this.varObj.liveMaxLatencyDurationCount=4;this.varObj.initialLiveManifestSize=1;this.varObj.forceKeyFrameOnDiscontinuity=!0;this.varObj.enableWebVTT=!1;this.varObj.enableCEA708Captions=!1;this.varObj.playerObject=this;this.todoErrorHint=!1;this.rateOffset="undefined"!=typeof this.options.rateOffset?this.options.rateOffset:0;this.autoSwitch="undefined"!=typeof this.options.autoSwitch?this.options.autoSwitch:!0;this.defaultMuted="undefined"!=typeof this.options.defaultMuted?this.options.defaultMuted:!0;this.maxChkCurrentTimes="undefined"!=typeof this.options.maxChkCurrentTimes?this.options.maxChkCurrentTimes:2;this.maxChkBufferdTimes="undefined"!=typeof this.options.maxChkBufferdTimes?this.options.maxChkBufferdTimes:5;this.maxChkReadyStateTimes="undefined"!=typeof this.options.maxChkReadyStateTimes?this.options.maxChkReadyStateTimes:5;this.maxChkSeekTimes="undefined"!=typeof this.options.maxChkSeekTimes?this.options.maxChkSeekTimes:2;this.maxDelaySec="undefined"!=typeof this.options.maxDelaySec?this.options.maxDelaySec:8;this.errorSendBack="undefined"!=typeof this.options.errorCallBack?this.options.errorCallBack:null;this.doInfo=-1;this.iNowNetErrorErrorCnt=0;this.RegId="undefined"!=typeof this.options.RegId?this.options.RegId:(new Date).getTime();this.bIsFirstPlayHint=!1;this.TotalChangeLineCnt=this.iErrorTotalCnt=0;this.MaxTotalChangeLineCnt=10;this.DelayStartTime=0;this.MaxDelayTimeGap=60};StreamPlayer.prototype.InitConnect=function(g,j,f,h){this.Stop();this.showLogs("Player InitConnect");var i=this;this.init=!0;this.bIsFirstPlayHint=!1;this.vUrl=j;this.linePart=f;this.chkLoadErrorTimes=0;this.resetVar();-1!=this.doInfo&&(clearInterval(this.doInfo),this.doInfo=-1);this.doInfo=setInterval(this.info.bind(this),1000);"undefined"!==typeof h&&(this.maxDelaySec=this.options.maxDelaySec=h);if(null==this.videoElm){if(this.videoElm=document.getElementById(g),this.videoElm.defaultMuted=this.defaultMuted,this.lastSoundState=this.videoElm.muted=this.defaultMuted,this.addTimedMetadataEvent(),!0===this.hlsSupport){this.HLSObj=new Hls(this.varObj),console.log("HLS Version:["+Hls.version+"]"),this.SetPloader(),this.HLSObj.startPosition=0,this.hlsEvent()}else{for(this.videoElm.crossorigin="use-credentials",this.videoElm.addEventListener("play",function(){i.showLogs("ElementEvent play")}),this.videoElm.addEventListener("loadstart",function(){i.showLogs("ElementEvent loadstart");var b=new XMLHttpRequest;b.onreadystatechange=function(){4==b.readyState&&200==b.status&&i.m3u8URLParse(b.responseText)};b.open("GET",i.vUrl,!0);b.send(null)}),this.videoElm.addEventListener("error",function(b){i.showLogs("Error code: "+b.currentTarget.error.code);b.currentTarget.error.message&&i.showLogs("Error message: "+b.currentTarget.error.message);i.showLogs("Error loading: "+i.vUrl);4===b.currentTarget.error.code&&(i.showLogs("call restart"),i.restart())}),this.videoElm.addEventListener("loadedmetadata",function(){i.showLogs("ElementEvent loadedmetadata")}),g=0;g<this.videoElm.textTracks.length;g++){"hidden"!=this.videoElm.textTracks[g].mode&&(this.videoElm.textTracks[g].mode="hidden")}}}else{this.videoElm.defaultMuted=this.lastSoundState,this.videoElm.muted=this.lastSoundState}!0===this.hlsSupport?(null!==this.playState?(this.showLogs("============= Restart Now ==============="),this.restart()):(this.HLSObj.loadSource(this.vUrl),this.HLSObj.attachMedia(this.videoElm),this.showLogs(this.vUrl)),this.todoErrorHint=!1):(this.todoErrorHint=!1,null!==this.playState?(this.showLogs("============= Restart Now ==============="),this.restart()):(this.videoElm.src=this.vUrl,this.videoElm.play(),this.playState=!0,this.init=!1))};StreamPlayer.prototype.addTimedMetadataEvent=function(){var b=this;this.videoElm.textTracks.addEventListener("addtrack",function(a){b.showLogs("textTracks: "+a.track.kind);"metadata"===a.track.kind&&(a.track.mode="hidden",a.track.addEventListener("cuechange",function(c){c=c.currentTarget.activeCues[c.currentTarget.activeCues.length-1];try{b.timedMeta=c.value.info}catch(d){b.timedMeta=null}null!=b.timedMeta&&(b.timedMetaTime=new Date(parseInt(b.timedMeta)))}))})};StreamPlayer.prototype.restart=function(){!1===this.init&&!0===this.autoSwitch?(this.linePart=0==this.linePart?1:0,this.errDetails="switch,"+this.linePart):(this.iNowNetErrorErrorCnt=0,!0===this.hlsSupport?(null!==this.HLSObj&&this.HLSObj.destroy(),this.playState=!1,this.HLSObj=new Hls(this.varObj),this.SetPloader(),this.hlsEvent(),this.HLSObj.loadSource(this.vUrl),this.HLSObj.attachMedia(this.videoElm)):(this.Pause(),this.playState=!1,this.videoElm.removeAttribute("src"),this.videoElm.src="",this.videoElm.src=this.vUrl,this.videoElm.play(),this.playState=!0,this.init=!1),-1!=this.doInfo&&(clearInterval(this.doInfo),this.doInfo=-1),this.resetVar(),this.doInfo=setInterval(this.info.bind(this),1000),this.showLogs(this.vUrl))};StreamPlayer.prototype.hlsEvent=function(){var b=this;this.HLSObj.on(Hls.Events.MEDIA_ATTACHED,function(){b.showLogs("MEDIA_ATTACHED");b.init=!1});this.HLSObj.on(Hls.Events.LEVEL_SWITCHING,function(d,a){b.showLogs("LEVEL_SWITCHING")});this.HLSObj.on(Hls.Events.MEDIA_DETACHED,function(){b.showLogs("MEDIA_DETACHED")});this.HLSObj.on(Hls.Events.MANIFEST_PARSED,function(){b.showLogs("MANIFEST_PARSED")});this.HLSObj.on(Hls.Events.LEVEL_LOADED,function(f,a){var d=(new Date).getTime();if(!0===b.playState&&(0==b.lastclientTime||2000<d-b.lastclientTime)){b.chkBase=btoa(a.networkDetails.responseText);b.chkBase===b.lastbase?++b.chkBasetimes:b.chkBasetimes=0;if(5<=b.chkBasetimes){b.restart();return}b.lastclientTime=d}b.lastbase=b.chkBase});this.HLSObj.on(Hls.Events.INIT_PTS_FOUND,function(d,a){b.showLogs("INIT_PTS_FOUND")});this.HLSObj.on(Hls.Events.FRAG_PARSING_INIT_SEGMENT,function(d,a){b.showLogs("FRAG_PARSING_INIT_SEGMENT");!1===b.todoErrorHint?(b.videoElm.play(),b.playState=!0,b.showLogs("start play")):(b.HLSObj.destroy(),b.showLogs("do destory"))});this.HLSObj.on(Hls.Events.FRAG_CHANGED,function(d,c){});this.HLSObj.on(Hls.Events.FRAG_PARSING_METADATA,function(d,a){b.showLogs("FRAG_PARSING_METADATA");b.showLogs(a.samples)});this.HLSObj.on(Hls.Events.FRAG_PARSING_DATA,function(d,a){b.TotalChangeLineCnt=0});this.HLSObj.on(Hls.Events.FRAG_BUFFERED,function(d,c){});this.HLSObj.on(Hls.Events.FPS_DROP,function(d,a){b.showLogs("FPS_DROP: "+a.currentDropped+"/"+a.currentDecoded)});this.HLSObj.on(Hls.Events.DESTROYING,function(d,a){b.showLogs("Events.DESTROYING")});this.HLSObj.on(Hls.Events.ERROR,function(d,a){b.showLogs("ERROR: "+a.type+"/"+a.details);b.iNowNetErrorErrorCnt+=1;b.showLogs("THISROOT.iNowNetErrorErrorCnt :["+b.iNowNetErrorErrorCnt+"]");if(a.fatal){switch(b.showLogs("Fatal error :"+a.type+"/"+a.details),a.type){case Hls.ErrorTypes.NETWORK_ERROR:"manifestLoadError"==a.details&&b.restart();!0===b.playState&&b.HLSObj.startLoad();break;case Hls.ErrorTypes.MEDIA_ERROR:b.HLSObj.recoverMediaError();break;case Hls.ErrorTypes.OTHER_ERROR:break;default:b.showLogs("cannot recover"),b.HLSObj.destroy()}}else{switch(a.type){case Hls.ErrorTypes.MEDIA_ERROR:switch(a.details){case Hls.ErrorDetails.BUFFER_NUDGE_ON_STALL:b.showLogs("BUFFER_NUDGE_ON_STALL"),b.HLSObj.startLoad()}}}})};StreamPlayer.prototype.SetPloader=function(){-1!=this.vUrl.indexOf("cdn4c-mx.akamaized.net")&&(this.HLSObj.config.xhrSetup=function(b,d){b.withCredentials=!0})};StreamPlayer.prototype.Pause=function(){this.videoElm&&!1===this.videoElm.paused&&this.videoElm.pause()};StreamPlayer.prototype.Resume=function(){this.videoElm&&!0===this.videoElm.paused&&this.videoElm.play()};StreamPlayer.prototype.Mute=function(){this.videoElm&&!1===this.videoElm.muted&&(this.videoElm.muted=!0,this.lastSoundState=this.videoElm.defaultMuted=!0)};StreamPlayer.prototype.unMute=function(){this.videoElm&&!0===this.videoElm.muted&&(this.videoElm.muted=!1,this.lastSoundState=this.videoElm.defaultMuted=!1)};StreamPlayer.prototype.Stop=function(){-1!=this.doInfo&&(clearInterval(this.doInfo),this.doInfo=-1);this.resetVar();this.videoElm&&(!1===this.hlsSupport?this.Pause():(this.Pause(),null!=this.HLSObj&&(this.HLSObj.stopLoad(),this.HLSObj.detachMedia()),this.showLogs(" do HLS Stop!! ")),this.vUrl=null,this.videoElm.removeAttribute("src"),this.videoElm.load(),this.playState=!1)};StreamPlayer.prototype.Volume=function(b){this.videoElm&&(this.videoElm.volume=b)};StreamPlayer.prototype.Seek=function(b){this.videoElm&&(this.showLogs("seek to "+b+" sec"),this.videoElm.currentTime=b)};StreamPlayer.prototype.UpdateURL=function(b){this.vUrl=b};StreamPlayer.prototype.PlaybackRate=function(b){this.videoElm&&(this.videoElm.playbackRate=b)};StreamPlayer.prototype.info=function(){var f=this;try{this.bufferTime=this.videoElm.buffered.end(0)}catch(g){this.bufferTime=0}this.readyState=this.videoElm.readyState;this.currentTime=this.videoElm.currentTime;this.delayTime=this.bufferTime-this.currentTime;this.logId&&(document.getElementById("readyState").innerHTML="<b>ReadyState: "+this.readyState+"<b>",document.getElementById("currentTime").innerHTML="<b>Current: "+this.currentTime+"<b>",document.getElementById("bufferTime").innerHTML="<b>Buffered: "+this.bufferTime+"<b>",document.getElementById("delayTime").innerHTML="<b>Delay: "+this.delayTime+"<b>",this.isMonitor||(document.getElementById("timedMeta").innerHTML="<b>TimedMeta: "+this.timedMeta+"<b>",document.getElementById("timedMetaTime").innerHTML="<b>TimedMetaTime: "+this.timedMetaTime+"<b>",this.videoElm.getVideoPlaybackQuality&&typeof this.videoElm.getVideoPlaybackQuality===typeof Function?document.getElementById("dropFrame").innerHTML="<b>DropFrame: "+this.videoElm.getVideoPlaybackQuality.droppedVideoFrames+"<b>":document.getElementById("dropFrame").innerHTML="<b>DropFrame: "+this.videoElm.webkitDroppedFrameCount+"<b>"));if(!1===this.videoElm.paused){if(this.lastCurrent!=this.currentTime?(this.lastCurrent=this.currentTime,this.chkCurrentTimes=0):(++this.chkCurrentTimes,f.showLogs("check Current: "+this.chkCurrentTimes)),this.chkCurrentTimes>=this.maxChkCurrentTimes){f.showLogs("check current to max count.");this.ErrorHint("403");return}}else{this.chkCurrentTimes=0}this.lastBufferd!=this.bufferTime?(this.lastBufferd=this.bufferTime,this.chkBufferdTimes=0):(++this.chkBufferdTimes,f.showLogs("check bufferd: "+this.chkBufferdTimes));if(this.chkBufferdTimes>=this.maxChkBufferdTimes){f.showLogs("check bufferd to max count."+this.maxChkBufferdTimes),this.ErrorHint("403")}else{if(2>this.readyState?(++this.chkReadyStateTimes,f.showLogs("check ReadyState: "+this.chkReadyStateTimes)):this.chkReadyStateTimes=0,this.chkReadyStateTimes>this.maxChkReadyStateTimes){f.showLogs("check ReadyState to max count."),this.ErrorHint("403")}else{if(!0===this.iOS){var h=(new Date).getTime();if(0==this.lastclientTime||2000<h-this.lastclientTime){var d=new XMLHttpRequest;d.onreadystatechange=function(){if(4==d.readyState&&200==d.status){f.chkBase=btoa(d.responseText);f.chkBase===this.lastbase?++this.chkBasetimes:this.chkBasetimes=0;if(5<=this.chkBasetimes){f.showLogs("check Loop to max count.");this.ErrorHint("403");return}this.lastclientTime=h}this.lastbase=f.chkBase};d.open("GET",f.m3u8Url,!0);d.send(null)}}!0!==this.hlsSupport&&!0!==this.iOS||this.chkSeek()}}};StreamPlayer.prototype.m3u8URLParse=function(e){this.m3u8URLtag=e.split("#");this.firstLevel=null;for(var f in this.m3u8URLtag){if(-1<this.m3u8URLtag[f].indexOf("EXT-X-STREAM-INF")){this.firstLevelarr=this.m3u8URLtag[f].split("\n");for(var d in this.firstLevelarr){if(-1<this.firstLevelarr[d].indexOf("m3u8")){this.firstLevel=this.firstLevelarr[d];break}}}}null!=this.firstLevel?-1<this.firstLevel.indexOf("http")?this.m3u8Url=this.firstLevel:(this.urlArr=this.vUrl.split("/"),this.m3u8Url=this.vUrl.replace(new RegExp(this.urlArr[this.urlArr.length-1],"g"),this.firstLevel)):this.m3u8Url=this.vUrl};StreamPlayer.prototype.chkSeek=function(){if(this.videoElm&&0!==this.delayTime){this.chkPlayBackTimes=this.delayTime-this.rateOffset>this.maxDelaySec/2+1?this.chkPlayBackTimes+1:0;2<this.chkPlayBackTimes?this.PlaybackRate(1.2):this.PlaybackRate(1);if(4<this.chkSeekTimes){if(!0===this.iOS){try{this.seekableEnd=this.videoElm.seekable.end(0)}catch(b){this.seekableEnd=0}this.showLogs("iOS seek time range->["+this.videoElm.seekable.start(0)+","+this.videoElm.seekable.end(0)+"]");this.seekableEnd>this.videoElm.currentTime&&this.Seek(this.seekableEnd)}else{!0===this.hlsSupport&&(this.seekTime=this.delayTime-this.maxDelaySec,this.Seek(this.videoElm.currentTime+this.seekTime))}}this.chkSeekTimes=this.delayTime>this.maxDelaySec?this.chkSeekTimes+1:0;this.delayTime>this.maxDelaySec&&this.chkSeekTimes>=this.maxChkSeekTimes&&(this.showLogs("Delay > "+this.maxDelaySec+" and seek failed, restart connect now "),this.restart())}};StreamPlayer.prototype.resetVar=function(){this.chkPlayBackTimes=this.chkBasetimes=this.chkLoadErrorTimes=this.chkSeekTimes=this.chkReadyStateTimes=this.chkBufferdTimes=this.chkCurrentTimes=this.lastbase=this.lastclientTime=this.lastBufferd=this.lastCurrent=this.delayTime=this.currentTime=this.readyState=this.bufferTime=0;this.errDetails=""};StreamPlayer.prototype.setLogId=function(b){this.logId=b;b=document.createElement("div");b.setAttribute("id","readyState");b.setAttribute("style","margin-top:10px");b.innerHTML="<b>ReadyState: <b>";document.body.appendChild(b);b=document.createElement("div");b.setAttribute("id","currentTime");b.setAttribute("style","margin-top:10px");b.innerHTML="<b>Current: <b>";document.body.appendChild(b);b=document.createElement("div");b.setAttribute("id","bufferTime");b.setAttribute("style","margin-top:10px");b.innerHTML="<b>Buffer: <b>";document.body.appendChild(b);b=document.createElement("div");b.setAttribute("id","delayTime");b.setAttribute("style","margin-top:10px");b.innerHTML="<b>Delay: <b>";document.body.appendChild(b);this.isMonitor||(b=document.createElement("div"),b.setAttribute("id","dropFrame"),b.setAttribute("style","margin-top:10px"),b.innerHTML="<b>DropFrame: <b>",document.body.appendChild(b),b=document.createElement("div"),b.setAttribute("id","timedMeta"),b.setAttribute("style","margin-top:10px"),b.innerHTML="<b>TimedMeta: <b>",document.body.appendChild(b),b=document.createElement("div"),b.setAttribute("id","timedMetaTime"),b.setAttribute("style","margin-top:10px"),b.innerHTML="<b>TimedMetaTime: <b>",document.body.appendChild(b),b=document.createElement("div"),b.setAttribute("id",this.logId),b.setAttribute("style","width:600px; height:300px; overflow:auto; background-color:#eee; margin-top:10px; "),document.body.appendChild(b))};StreamPlayer.prototype.ErrorHint=function(b){var d=!1;!0===this.todoErrorHint?console.log("errorhint be return :["+b+"]"):("001"!==b&&(this.TotalChangeLineCnt+=1,this.TotalChangeLineCnt<=this.MaxTotalChangeLineCnt?(d=!0,this.DelayStartTime=Date.now()/1000):Date.now()/1000-this.DelayStartTime>=this.MaxDelayTimeGap&&(d=!0,this.DelayStartTime=Date.now()/1000)),1==d&&(this.todoErrorHint=!0,-1!=this.doInfo&&(this.showLogs("to do stop info setInterval!!"),clearInterval(this.doInfo),this.doInfo=-1),this.Stop(),null!=this.errorSendBack&&this.errorSendBack(this.RegId,b)))};StreamPlayer.prototype.showLogs=function(e){var f=new Date;f="["+f.getFullYear()+"-"+(f.getMonth()+1)+"-"+f.getDate()+" "+f.getHours()+":"+f.getMinutes()+":"+f.getSeconds()+":"+f.getMilliseconds()+"]";if(!0===this.debug&&(console.warn(f+" "+e),""!=this.logId)){var d="<br/>"+$j("#"+this.logId).html();$j("#"+this.logId).html(f+" "+e+d)}};StreamPlayer.prototype.pStatus=function(b){this.showLogs(b)};