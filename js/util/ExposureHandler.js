if(typeof ExposureHandler=="undefined"){ExposureHandler={}}(function(){var f=true;MarketExposureObj={eventId:null,marketId:null,numberOfWinner:0,defaultActiveRunners:0,numberOfActiveRunners:0,marketExposure:0,betSelections:{}};SelectionExposureObj={minExposure:0,diff:0,selectionWinPL:0,selectionLossPL:0};NotActiveSelectionIds=[];function j(){MarketExposureObj.eventId=null;MarketExposureObj.marketId=null;MarketExposureObj.numberOfWinner=0;MarketExposureObj.defaultActiveRunners=0;MarketExposureObj.numberOfActiveRunners=0;MarketExposureObj.marketExposure=0;MarketExposureObj.betSelections={};SelectionExposureObj.minExposure=0;SelectionExposureObj.diff=0;SelectionExposureObj.selectionWinPL=0;SelectionExposureObj.selectionLossPL=0;NotActiveSelectionIds=[]}ExposureHandler.getMarketExposure=function(){return k(MarketExposureObj)};ExposureHandler.setMarketExposure=function(l){j();MarketExposureObj=k(l)};ExposureHandler.initMarketInfo=function(m,p,n,o,l){if(!$j.isArray(l)){throw"notActiveSelectionIdArr must bet array"}j();MarketExposureObj.eventId=m;MarketExposureObj.marketId=p;MarketExposureObj.numberOfWinner=n;MarketExposureObj.defaultActiveRunners=o;MarketExposureObj.numberOfActiveRunners=o;NotActiveSelectionIds=l;if(n==1){MarketExposureObj.betSelections[0]=k(SelectionExposureObj)}};ExposureHandler.generatorBetTicketObj=function(l,t,p,v,m,n,q,o,u){var s=MathUtil.decimal.multiply(n==1?1:-1,MathUtil.decimal.multiply(MathUtil.decimal.subtract(v,1),m));var r=MathUtil.decimal.multiply(n==1?-1:1,m);s=!q&&s>0?0:s;r=!q&&r>0?0:r;return{eventId:l,marketId:t,selectionId:p,selectionWinPL:s,selectionLossPL:r}};ExposureHandler.calculateExposure=function(l){if(!$j.isArray(l)){throw"betTickets must bet array type.[betTicketObj....]"}if(MarketExposureObj.numberOfWinner==1){$j.each(l,function(m,n){i(n)})}else{c(l)}};function i(p){var n=p.selectionId;MarketExposureObj.betSelections[n]=MarketExposureObj.betSelections[n]||k(MarketExposureObj.betSelections[0]);var o=Object.keys(MarketExposureObj.betSelections).length-1;g();var m=o==MarketExposureObj.numberOfActiveRunners;var l=0;$j.each(MarketExposureObj.betSelections,function(s,q){var r=q.minExposure;if(n==s){r=MathUtil.decimal.add(r,p.selectionWinPL)}else{r=MathUtil.decimal.add(r,p.selectionLossPL)}q.minExposure=r;if(m&&s==0){return}l=e(l,r)});MarketExposureObj.marketExposure=l}function c(l){$j.each(l,function(s,v){var u=v.selectionId;var r=MarketExposureObj.betSelections[u]||k(SelectionExposureObj);r.selectionWinPL=MathUtil.decimal.add(r.selectionWinPL,v.selectionWinPL);r.selectionLossPL=MathUtil.decimal.add(r.selectionLossPL,v.selectionLossPL);r.diff=MathUtil.decimal.subtract(r.selectionWinPL,r.selectionLossPL);if(MarketExposureObj.numberOfWinner==0){var t=e(r.selectionWinPL,r.selectionLossPL);r.minExposure=e(t,0)}MarketExposureObj.betSelections[u]=r});var o=0;if(MarketExposureObj.numberOfWinner==0){$j.each(MarketExposureObj.betSelections,function(s,r){o=MathUtil.decimal.add(o,r.minExposure)})}else{var n=0;var m=0;var p=Object.keys(MarketExposureObj.betSelections).length;g();var q=MarketExposureObj.numberOfActiveRunners-MarketExposureObj.numberOfWinner;if(p<MarketExposureObj.numberOfWinner){n=0;m=p}else{if(p>=MarketExposureObj.numberOfWinner&&p<=q){n=0;m=MarketExposureObj.numberOfWinner}else{n=p-q;m=MarketExposureObj.numberOfWinner}}o=d(n,m)}MarketExposureObj.marketExposure=o}function d(n,l){var o=0;for(var m=n;m<=l;m++){var p;if(f){p=a(m)}else{p=b(m)}o=e(o,p)}return o}function b(m){var l=Object.keys(MarketExposureObj.betSelections);var n=0;CombinationHandler.generator(l,m,function(o){var p=0;$j.each(MarketExposureObj.betSelections,function(r,q){if(o.indexOf(r)!=-1){p=MathUtil.decimal.add(p,q.selectionWinPL)}else{p=MathUtil.decimal.add(p,q.selectionLossPL)}});Trace.debug("win selections:["+o+"],exposure:"+p);n=e(n,p)});Trace.debug("winner:["+m+"],exposureOfWinner:"+n);return n}function a(o){var p=[];$j.each(MarketExposureObj.betSelections,function(t,s){s.selectionId=t;p.push(s)});p.sort(function(v,u){var t=v.diff;var s=u.diff;return(t>s)?1:((t<s)?-1:0)});var q=[];var n=0;for(var m=0;m<p.length;m++){var l=p[m];if(m<o){q.push(l.selectionId);n=MathUtil.decimal.add(n,l.selectionWinPL)}else{n=MathUtil.decimal.add(n,l.selectionLossPL)}}Trace.debug("win selections:["+q+"],exposure:"+n);var r=e(0,n);Trace.debug("winner:["+o+"],exposureOfWinner:"+r);return r}function k(l){return JSON.parse(JSON.stringify(l))}function e(m,l){return m>l?l:m}function h(m,l){return m<l?l:m}function g(){var l=Object.keys(MarketExposureObj.betSelections);var m=0;$j.each(l,function(n,o){if(NotActiveSelectionIds.indexOf(parseInt(o))!=-1){m++}});if(m==0){return}MarketExposureObj.numberOfActiveRunners=MarketExposureObj.defaultActiveRunners+m}})();