if(typeof(BookMakerMarketHandler)=="undefined"){BookMakerMarketHandler={}}(function(){BookMakerMarketHandler.queryTask=null;var i=new HashMap();BookMakerMarketHandler.init=function(){if(!BookMakerMarketHandler.isEnableBookMaker()){return}BookMakerMarketHandler.initTask()};BookMakerMarketHandler.isEnableBookMaker=function(){return PageConfig.isEnableBookMaker};BookMakerMarketHandler.isShowBookMaker=function(){return BookMakerMarketHandler.isEnableBookMaker()&&PageConfig.hasBookMakerMarkets};BookMakerMarketHandler.isViewMultiMarket=function(){return location.href.indexOf("multiMarkets")>-1};BookMakerMarketHandler.initTask=function(){if(BookMakerMarketHandler.queryTask==null){var p=TaskExecuter.createTask(PageConfig.getBookMakerMarketsTaskCycleTime,0,function(){BookMakerMarketHandler.queryBookMakerMarkets(this)});p.version=0;p.oddsSettingVersion=0;p.selectionTs=0;BookMakerMarketHandler.queryTask=p}else{BookMakerMarketHandler.queryTask.isStop=false}BookMakerMarketHandler.queryTask.run();TaskExecuter.execute()};BookMakerMarketHandler.abortTask=function(){if(BookMakerMarketHandler.queryTask!=null){BookMakerMarketHandler.queryTask.stop()}};BookMakerMarketHandler.queryBookMakerMarkets=function(p){try{$j.ajax({type:"POST",dataType:"JSON",url:"/exchange/member/playerService/queryBookMakerMarkets",data:{eventId:PageConfig.selectEventId,version:p.version,oddsSettingVersion:p.oddsSettingVersion,selectionTs:p.selectionTs},success:function(r){try{if(!r){return}if(r.version>p.version){p.version=Math.max(r.version,p.version)}if(r.oddsSettingVersion>p.oddsSettingVersion){p.oddsSettingVersion=Math.max(r.oddsSettingVersion,p.oddsSettingVersion)}if(r.selectionTs>p.selectionTs){p.selectionTs=Math.max(r.selectionTs,p.selectionTs)}BookMakerMarketHandler.updateBookMakerMarkets(r)}catch(s){Trace.printStackTrace(s)}},error:function(t,r,s){Trace.log(t.status);Trace.log(s)}})}catch(q){Trace.printStackTrace(q)}finally{p.check();TaskExecuter.execute()}};function e(p){var q=p.bookMakerEvent.eventId;if(p.bookMakerMarket.markets.length!=0){DataBase.bookMakerMarkets.update(q,p.bookMakerMarket.markets)}if(p.bookMakerSelection.selections.length!=0){DataBase.bookMakerMarkets.updateSelection(q,p.bookMakerSelection.selections)}}BookMakerMarketHandler.updateBookMakerMarkets=function(t){if(!t.bookMakerEvent||!t.bookMakerMarket||!t.bookMakerSelection){return}e(t);var r=t.bookMakerEvent.eventType;var p=t.bookMakerEvent.eventId;var z=t.bookMakerEvent.highlightMarketId;var u=t.bookMakerEvent.eventName;var q=$j("#overWrap");var y=BookMakerMarketHandler.getBookMakerWrap(q,p,BookMakerMarketHandler.isViewMultiMarket());var x=y.find("#bookMakerTempTable");var v=y.find("#bookMakerHead");if(BookMakerMarketHandler.isViewMultiMarket()){y.find(".multi_name").unbind("click").click(function(){location.href=PageConfig.fullMarketPath+"?eventType="+r+"&eventId="+p+"&marketId="+z});y.find("#multiMarketRefresh").unbind("click").click(function(){y.find("#multiMarketLoading").show();setTimeout(function(){y.find("#multiMarketLoading").hide()},500)});if(!t.bookMakerMarket.markets.length==0){y.find("#min").html(CurrencyUtil.formatter(t.bookMakerMarket.markets[0].min,A));y.find("#max").html(CurrencyUtil.formatter(t.bookMakerMarket.markets[0].max,A));if(t.bookMakerMarket.markets[0].rebateRatio==0){y.find("#rebateName").hide();y.find("#rebate").hide()}else{y.find("#rebateName").show();y.find("#rebate").html(MathUtil.decimal.multiply(t.bookMakerMarket.markets[0].rebateRatio,100)+"%").show()}v.find("#eventName").text(u)}y.show()}var s=y.find("#bookMakerMarketList");var w=CurrencyType.getInstanceOf(PageConfig.playerCurrency);var A={precision:2,separateSign:",",currencySymbol:w.symbol,formatter:CurrencyUtil.DefaultFormatter,"trailingZeros,":false};if(a(DataBase.bookMakerMarkets.queryByEvent(p))){s.show();if(BookMakerMarketHandler.isViewMultiMarket()){v.find(".game-bookmaker").addClass("in-play")}}else{if(BookMakerMarketHandler.isViewMultiMarket()){y.hide()}y.hide();s.hide()}h(s,x,t);k(s,x,t);f()};function h(t,A,u){if(u.bookMakerMarket.markets.length==0){return}var q=u.bookMakerEvent.eventId;var s=u.bookMakerEvent.eventType;var r=u.bookMakerMarket.markets;var z=CurrencyType.getInstanceOf(PageConfig.playerCurrency);var C={precision:2,separateSign:",",currencySymbol:z.symbol,formatter:CurrencyUtil.DefaultFormatter,"trailingZeros,":false};r.sort(function(E,D){return BookMakerMarketUtil.sortMarkets(E.sort,D.sort,E.marketType,D.marketType)});for(var x=0,y=r.length;x<y;x++){var p=r[x];var B=p.marketId;var v=p.status;if(BookMakerMarketUtil.isOffline(v)){continue}var w=t.find("#bookMakerMarket_"+DataBase.bookMakerMarkets.getMarketKey(q,B));if(w.length==0){if(BookMakerMarketUtil.isClosed(v)){continue}w=j(t,A,q,p)}MultiMarketsHandler.appendBookMakerPin(s,q,B,BookMakerMarketHandler.isViewMultiMarket());m(t,w,p,q,C);d(t,w,p,q,B)}FancyBetMarketUtil.checkForAllClose(q)}function j(u,p,r,s){var t=p.find("#bookMakerMarketTemplate").clone();var q=DataBase.bookMakerMarkets.getMarketKey(r,s.marketId);t.prop("id","bookMakerMarket_"+q);t.prop("eventId",r);t.prop("marketId",s.marketId);t.prop("marketType",s.marketType);t.prop("status",s.status);t.prop("summaryStatus",s.summaryStatus);t.prop("updateDate",s.updateDate);t.prop("marketName",s.marketName);if(s.remarkFirstRow!=null&&s.remarkFirstRow.length>0){t.find("#remarkFirstRow").show();t.find("#remarkFirstRow").html(s.remarkFirstRow)}if(s.remarkSecondRow!=null&&s.remarkSecondRow.length>0){t.find("#remarkSecondRow").show();t.find("#remarkSecondRow").html(s.remarkSecondRow)}u.append(t.show());return t}function m(t,s,r,q,p){s.prop("sort",r.sort);t.find("#min").html(CurrencyUtil.formatter(r.min,p));t.find("#max").html(CurrencyUtil.formatter(r.max,p));if(r.rebateRatio==0){s.find("#rebateName").hide();s.find("#rebate").hide()}else{s.find("#rebateName").show();s.find("#rebate").show();s.find("#rebate").html(MathUtil.decimal.multiply(r.rebateRatio,100)+"%")}}function d(t,q,u,r,s){var p=t.find("[id^=bookMakerSuspend_][marketId="+s+"]");if(p.length==0){return}$j.each(p,function(x,v){v=t.find(p[x]);if(v==null||v.length==0){return true}var w=v.prop("selectionId");g(t,q,u,r,s,w,v)})}function o(q,r,p){BookMakerBetHandler.hideBetBoardBySelection(q,r,p);BookMakerMarketHandler.removeSelectClass()}function k(E,w,q){if(q.bookMakerSelection.selections.length==0){return}var z=q.bookMakerEvent;var v=q.bookMakerEvent.eventId;var p=q.bookMakerSelection.selections;var t=false;p.sort(function(I,H){return BookMakerSelectionUtil.sort(I.marketId,H.marketId,I.sort,H.sort)});for(var A=0,B=p.length;A<B;A++){var G=p[A];var s=G.marketId;var D=G.selectionId;var u=DataBase.bookMakerMarkets.get(v,s);if(u==null||BookMakerMarketUtil.isClosed(u.status)){continue}var C=E.find("#bookMakerMarket_"+DataBase.bookMakerMarkets.getMarketKey(v,s));if(C.length==0){continue}var F=DataBase.bookMakerMarkets.getSelectionKey(v,s,D);var y=C.find("#bookMakerSelection_"+F);if(y.length==0){y=c(E,C,w,z,u,G);t=true}BookMakerSelectionUtil.updateSelectionOdds(C,y,G);var x=y.find("#back_1");var r=y.find("#lay_1");SparkHandler.addFancyBetSpark(x,null,x.find("a").text());SparkHandler.addFancyBetSpark(r,null,r.find("a").text());b(E,C,y,v,u,G,t)}}function c(q,s,v,p,r,w){var y=w.marketId;var t=w.selectionId;var x=DataBase.bookMakerMarkets.getSelectionKey(p.eventId,w.marketId,t);var z=v.find("#suspendTemplate").clone();z.prop("id","bookMakerSuspend_"+x);z.prop("selectionId",t);z.attr("marketId",y);s.append(z);var u=v.find("#bookMakerSelectionTemplate").clone();u.prop("id","bookMakerSelection_"+x);u.prop("eventId",p.eventId);u.prop("marketId",y);u.prop("selectionId",t);u.find("#runnerName").html(w.runnerName);n(s,u,u.find("[id^=back_]"),p,r,w,SideType.Back.unique());n(s,u,u.find("[id^=lay_]"),p,r,w,SideType.Lay.unique());s.append(u.show());return u}function b(q,s,u,p,r,v,t){var w=DataBase.bookMakerMarkets.getSelectionKey(p,v.marketId,v.selectionId);var x=q.find("#bookMakerSuspend_"+w);if(x.length==0){return}g(q,s,r,p,v.marketId,v.selectionId,x,t)}function g(r,t,s,p,y,u,z,v){var x=DataBase.bookMakerMarkets.getMarketKey(p,y);var q={eventId:p,marketId:y};if(BookMakerMarketUtil.isOnline(s.status)&&!BookMakerMarketUtil.isClosed(s.status)){t.show()}if(v){i.put(x,q)}z.find("#suspendClass").removeClass("fancy-suspend");var w=DataBase.bookMakerMarkets.getSelection(p,y,u);if(w==null){return}if(BookMakerSelectionUtil.isSuspend(w.status)){z.find("#suspendClass").addClass("fancy-suspend");z.find("#info").html("Suspend");z.fadeIn();o(p,y,u);i.put(x,q);return}if(BookMakerMarketUtil.isSuspend(s.status)){z.find("#suspendClass").addClass("fancy-suspend");z.find("#info").html("Suspend");z.fadeIn();o(p,y,u);i.put(x,q);return}else{if(BookMakerMarketUtil.isBallRun(s.status)){z.find("#suspendClass").addClass("fancy-suspend");z.find("#info").html("Ball Running");z.fadeIn();o(p,y,u);i.put(x,q);return}else{if(BookMakerMarketUtil.isClosed(s.status)||BookMakerMarketUtil.isOffline(s.status)){z.find("#suspendClass").addClass("fancy-suspend");z.find("#info").html("Closed");z.hide();o(p,y,u);i.put(x,q);t.hide();return}}}z.hide()}function f(){if(i.size()==0){return}var p=i.values();for(var q in p){var r=p[q];if(r==null){continue}BookMakerBetHandler.getExposure(r.eventId,r.marketId)}i.clear()}BookMakerMarketHandler.getDelayBettingElem=function(p,w,t){var q=$j("#overWrap");var v=q.find("#bookMakerTempTable");var r=q.find("#bookMakerMarketList");var u=r.find("#bookMakerSelection_"+DataBase.bookMakerMarkets.getSelectionKey(p,w,t));if(u.length==0||!u.is(":visible")){return null}var x=r.find("#bookMakerSuspend_"+DataBase.bookMakerMarkets.getSelectionKey(p,w,t));if(x.length==0||x.is(":visible")){return null}var s=r.find("#delayBetting_"+DataBase.bookMakerMarkets.getSelectionKey(p,w,t));if(s.length==0){s=v.find("#delayTemplate").clone();s.prop("id","delayBetting_"+DataBase.bookMakerMarkets.getSelectionKey(p,w,t));u.before(s)}return s};BookMakerMarketHandler.showDelayBetting=function(r,t,q){var u=DataBase.bookMakerMarkets.get(r,t);var s=u.delayBetting?parseInt(u.delayBetting)*1000:0;if(s==0){return}var p=BookMakerMarketHandler.getDelayBettingElem(r,t,q);if(p==null||p.length==0){return}p.find("#info").html("");p.fadeIn();setTimeout(function(){p.find("#info").html("");p.fadeOut()},s)};BookMakerMarketHandler.hideDelayBetting=function(r,s,q){var p=BookMakerMarketHandler.getDelayBettingElem(r,s,q);if(p==null||p.length==0){return}p.find("#info").html("");p.hide()};BookMakerMarketHandler.getBookMakerWrap=function(q,p,r){var s=q.find("#bookMakerTable_"+p);if(r){if(s.length==0){s=q.find("#bookMakerTableTemplate").clone();s.prop("id","bookMakerTable_"+p);s.attr("name","multiMarketItem");q.find("#header").after(s)}}else{s=q.find("#bookMakerWrap").show()}return s};function n(w,v,q,t,s,u,r){var p=function(A,E,F,y,x,G,B,z,C,D){return function(){var K=DataBase.bookMakerMarkets.get(x,G);if(K==null||BookMakerMarketUtil.isSuspend(K.status)||BookMakerMarketUtil.isClosed(K.status)){return}var J=DataBase.bookMakerMarkets.getSelection(x,G,B);if(J==null||BookMakerSelectionUtil.isSuspend(J.status)){return}var I=BookMakerSelectionUtil.getOddsInfoJson(z,J);if(I==null){return}var H=I[0];if(H==null||isNaN(H)){return}H=parseFloat(H);if(H==0||isNaN(H)){return}if(PageConfig.ENABLE_ONE_CLICK_BET=="true"&&OneClickBetHandler.isEnable()&&PageConfig.isOneClickBet==1){if(!PageConfig.ENABLE_ONE_CLICK_BET_ALL_PAGE){}else{if(!OneClickBetHandler.isEnableSubmitOneClickBet()){return}OneClickBetHandler.placeBookMakerBet(E,y,x,G,B,z,H);return}}l(E,z);BookMakerBetHandler.appendBoard(A,E,y,x,G,B,z,H,C,D)}}(w,v,q,t.eventType,t.eventId,u.marketId,u.selectionId,r,t.eventName,s.marketName);q.on("click",p)}function l(p,q){BookMakerMarketHandler.removeSelectClass();p.find("#"+SideType.getInstanceOf(q).name.toLowerCase()+"_1").addClass("select")}BookMakerMarketHandler.removeSelectClass=function(){var q=$j("#overWrap");var p=q.find("[id^=bookMakerMarket_]");p.find("#lay_1").removeClass("select");p.find("#back_1").removeClass("select")};function a(p){var r=false;for(var q in p){var s=p[q];if(BookMakerMarketUtil.isOnline(s.status)&&!BookMakerMarketUtil.isClosed(s.status)){r=true;break}}return r}})();if(typeof(DataBase)=="undefined"){DataBase={}}(function(){DataBase.bookMakerMarkets={};var a=new TreeMap();DataBase.bookMakerMarkets.update=function(e,c){var f=a.get(e);if(f==null){f=new TreeMap();a.put(e,f)}for(var d=0;d<c.length;d++){var g=c[d];var b=f.get(g.marketId);if(b!=null&&b.selectionMap!=null){g.selectionMap=b.selectionMap}f.put(g.marketId,g)}};DataBase.bookMakerMarkets.updateSelection=function(g,f){var h=a.get(g);if(h==null){Trace.log("eventId: "+g+" is not exist");return}for(var d=0,b=f.length;d<b;d++){var e=f[d];var c=h.get(e.marketId);if(c==null){Trace.log("marketId: "+e.marketId+" is not exist");continue}if(c.selectionMap==null){c.selectionMap=new TreeMap()}c.selectionMap.put(e.selectionId,e)}};DataBase.bookMakerMarkets.get=function(b,d){var c=a.get(b);if(c==null){return null}return c.get(d)};DataBase.bookMakerMarkets.queryByEvent=function(b){var c=a.get(b);if(c==null){c=new TreeMap();a.put(b,c)}return c.values()};DataBase.bookMakerMarkets.getSelection=function(d,e,c){var f=DataBase.bookMakerMarkets.get(d,e);if(f==null){return null}var b=f.selectionMap;if(b==null){return null}return b.get(c)};DataBase.bookMakerMarkets.queryAll=function(){return a.values()};DataBase.bookMakerMarkets.getMarketKey=function(b,c){return b+"_"+c};DataBase.bookMakerMarkets.getSelectionKey=function(c,d,b){return c+"_"+d+"_"+b}})();