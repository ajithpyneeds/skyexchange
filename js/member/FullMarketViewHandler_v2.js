if(typeof(FullMarketViewHandler)=="undefined"){FullMarketViewHandler={}}(function(){FullMarketViewHandler.webSocketUtil=null;FullMarketViewHandler.initWebSocket=function(){if(PageConfig.selectEventId==-1||PageConfig.selectMarketId==null){return}if(FullMarketViewHandler.webSocketUtil==null){FullMarketViewHandler.webSocketUtil=new WebSocketUtil()}if(!FullMarketViewHandler.webSocketUtil.isSupportWebSocket()){return}var f=PageConfig.marketOddsServicePath+"?eventId="+PageConfig.selectEventId+"&marketId="+PageConfig.selectMarketId+"&isMultiMarket=false";var e=function(h){try{h=JSON.parse(h)}catch(j){Trace.log(j);return}JsCache.get("#loading").hide();if(PageConfig.selectEventType==-1&&PageConfig.selectEventId==h.eventId&&PageConfig.selectMarketId==h.marketId){PageConfig.selectEventType=h.eventType}var g=$j("#fullMarketBetsWrap");var i=$j("#fullMarketBoard");FullMarketUtil.updateSelection(g,i,h.eventType,h.eventId,h.marketId,h.selections,true,reponse.gameProductStatus);if(PageConfig.ENABLE_CASH_OUT=="true"){CashOutHandler.updateCashOutInfo(h.cash)}};if(FullMarketViewHandler.webSocketUtil.getReadyState()==null||FullMarketViewHandler.webSocketUtil.getReadyState()==3||FullMarketViewHandler.webSocketUtil.eventId!=PageConfig.selectEventId||FullMarketViewHandler.webSocketUtil.marketId!=PageConfig.selectMarketId){FullMarketViewHandler.webSocketUtil.initialize(f,e)}if(FullMarketViewHandler.webSocketUtil.eventId!=PageConfig.selectEventId||FullMarketViewHandler.webSocketUtil.marketId!=PageConfig.selectMarketId){FullMarketViewHandler.webSocketUtil.eventId=PageConfig.selectEventId;FullMarketViewHandler.webSocketUtil.marketId=PageConfig.selectMarketId}};FullMarketViewHandler.isEnableFullMarketWebSocket=function(){if(PageConfig.ENABLE_FULL_MARKET_WEBSOCKET=="true"){if(PageConfig.ENABLE_WEBSOCKET_ONLY_MAZAPLAY=="true"){if(PageConfig.webSiteType==WebSiteType.MAZAPLAY.unique()){return true}else{return false}}else{return true}}return false};FullMarketViewHandler.getFullMarketsTask=null;FullMarketViewHandler.initTask=function(){if(FullMarketViewHandler.getFullMarketsTask==null){var e=TaskExecuterV2.createTask(PageConfig.getFullMarketsTaskCycleTime,0,function(){b(this)});FullMarketViewHandler.getFullMarketsTask=e}else{FullMarketViewHandler.getFullMarketsTask.isStop=false}e.isGetRunnerMetadata=true;FullMarketViewHandler.getFullMarketsTask.run();TaskExecuterV2.execute()};FullMarketViewHandler.abortTask=function(){if(FullMarketViewHandler.getFullMarketsTask!=null){FullMarketViewHandler.getFullMarketsTask.stop()}};function b(e){if(location.hash.indexOf("#marketId#")==0){var h=location.hash.split("#");if(h.length==4){var g=h[2];var f=h[3];PageConfig.selectEventId=f;PageConfig.selectMarketId=g}}if(PageConfig.selectEventId==-1||PageConfig.selectMarketId==null){e.check();TaskExecuterV2.execute();return}$j.ajax({type:"POST",dataType:"JSON",url:PageConfig.queryFullMarketsPath,data:{eventId:PageConfig.selectEventId,marketId:PageConfig.selectMarketId,selectionTs:-1,isGetRunnerMetadata:e.isGetRunnerMetadata},success:function(k){try{JsCache.get("#loading").hide();if(!k){return}if(PageConfig.selectEventType==-1&&PageConfig.selectEventId==k.eventId&&PageConfig.selectMarketId==k.marketId){PageConfig.selectEventType=k.eventType}if(k.market!=null&&k.market.eventId!=null){DataBase.markets.update(k.market.eventId,[k.market])}FullMarketViewHandler.updateFullMarkets(k);if(PageConfig.ENABLE_CASH_OUT=="true"){CashOutHandler.updateCashOutInfo(k.cash)}if(FullMarketViewHandler.isEnableFullMarketWebSocket()){var j=k.market.inPlay;var i=k.market.marketType;if(i=="MATCH_ODDS"&&j==1){FullMarketViewHandler.initWebSocket()}}if(PageConfig.isCheckMarketBetLimitSetting&&k.market!=null&&EventType.ELECTION.unique()!=k.eventType&&EventType.FANCYBET.unique()!=k.eventType){d(k.market)}}catch(l){Trace.printStackTrace(l)}finally{e.check();TaskExecuterV2.execute()}},error:function(){e.check();TaskExecuterV2.execute()}})}FullMarketViewHandler.updateFullMarkets=function(f){var o=f.eventType;var t=f.eventId;var h=f.marketId;var m=f.market;var G=f.gameProductStatus;if(PageConfig.selectMarketId!=h){Trace.info("selectMarketId: "+PageConfig.selectMarketId+" marketId: "+h);return}var p=EventType.getInstanceOf(o);var j=(PageConfig.isTodaysCard>=0)?true:false;if(m==null||m.marketId==null){if(p!=null&&p.isRacingEvent()&&j){MemberPage.view("marketClose");UiUtils.appendHeight()}return}var r=$j("#fullMarketBetsWrap");var F=$j("#fullMarketBoard");var k=$j("[id^='fullSelection_']");r.attr("eventType",o);r.attr("eventId",t);r.attr("marketId",h);if(k!=null&&k.length>0){for(var B=0;B<k.length;B++){var x=k[B];if($j(x).attr("marketId")!=h.replace(".","_")){$j(x).remove()}}}var H=(MarketUtil.isCloseSite(m.closeSite,PageConfig.webSiteType)||EventUtils.isCloseSite(f.eventCloseSite,PageConfig.webSiteType)||CompetitionUtils.isCloseSite(f.competitionCloseSite,PageConfig.webSiteType));if(p.isRacingEvent()&&(MarketUtil.isClosed(m.status)||H)&&!j){FullMarketViewHandler.changeToNextOpenRacingMarket();return}if(!p.isRacingEvent()&&(MarketUtil.isClosed(m.status)||H)){MessageUtils.showThenGoToIndex("market is closed");return}if(p.isRacingEvent()&&MarketUtil.isClosed(m.status)&&j){MemberPage.view("marketClose");UiUtils.appendHeight();return}JsCache.get("#refreshButton").unbind("click").click(function(){JsCache.get("#loading").show();FullMarketViewHandler.getFullMarketsTask.refresh()});var z=DataBase.events.get(o,t);if(z==null){return}var D='<img class="icon-time" src="/images/transparent.gif" />';if(m.inPlay==1&&!MarketUtil.isClosed(m.status)){D='<img class="icon-irun" src="/images/transparent.gif" />'}var w=$j("#gameHead");if(PageConfig.hasLiveMatchTracker){w=$j("#liveMatchGameHead")}var s=w.find("#gameInfoDate");if(s.length!=0){if(m.inPlay==1){s.addClass("green");s.removeClass("red");s.html(D+" In-Play")}else{s.removeClass("green");s.removeClass("red");s.html(D+" "+UiUtils.getShortDayName(z.openDateDayOfWeek)+" "+m.marketTimeStr)}if(MarketUtil.isClosed(m.status)){s.removeClass("green");s.addClass("red");s.html(D+I18N.get("form.text.market.closed"))}}if(PageConfig.hasLiveMatchTracker){MemberPage.view("liveMatchTracker");c(w,m)}else{if(m.inPlay==1&&!MarketUtil.isClosed(m.status)&&f.scores!=null&&LiveScoreHandler.isEnableLiveScore()){c(w,m);MemberPage.view("marketLiveScore");PageConfig.useBetfairScores=true;LiveScoreHandler.appendInfo(f.scores,f.matchInfo,f.scoresDetail,f.timeElapsed,o,t,h)}else{if(PageConfig.useSportradarScorecard||PageConfig.useSportsBookScorecard){var A;c(w,m);if(PageConfig.useSportradarScorecard){A=SportradarScorecardHandler.getBoardByEventType(PageConfig.selectEventType)}else{A=OwScorecardHandler.getBoardByEventType(PageConfig.selectEventType)}if(o!=null&&t!=null&&h!=null){MultiMarketsHandler.appendGameHeadPin(o,t,h,A)}}else{if(f.livescores!=null){c(w,m);MemberPage.view("marketLiveScore");var q=JSON.parse(f.livescores);TraderInputLiveScoreHandler.appendInfo(q,f)}else{MemberPage.view("market");MultiMarketsHandler.appendGameHeadPin(o,t,h)}}}UiUtils.appendHeight()}var v={precision:0,separateSign:",",currencySymbol:PageConfig.currencySymbol==null?"$":PageConfig.currencySymbol,formatter:CurrencyUtil.DefaultFormatter,"trailingZeros,":false};var y=CurrencyUtil.formatter(m.totalMatched>0?m.totalMatched:0,v);var n=w.find("#gameMatched");if(PageConfig.hasLiveMatchTracker||PageConfig.hasCricketLiveMatchTracker){n=w.find("#liveGameMatched")}n.html(PageConfig.playerCurrencyType+" "+y);if(BetHandler.isEnableCheckLowLiquidity()){if(BetHandler.isLowLiquidity(o,t,h.replace("_","."))){FullMarketUtil.showLowLiquidityTag(w.find("#lowLiquidityTag"),true)}else{FullMarketUtil.showLowLiquidityTag(w.find("#lowLiquidityTag"),false)}}if(PageConfig.ENABLE_LINE_MARKET&&MarketUtil.isLineMarket(m.marketType,m.bettingType)){var g=r.find("#lineMarketName");g.find("span").html(m.marketName);g.show()}if(m.inPlay==1&&PageConfig.hasAccount&&f.streamingChannel!=null&&f.streamingChannel!="0"&&!PageConfig.userCloseStreaming){if(f.streamingChannel!=PageConfig.streamingChannel){StreamingHandler.openStreamingBox(f.streamingChannel,f.eventType)}PageConfig.streamingChannel=f.streamingChannel}else{StreamingHandler.closeStreamingBox();if(!PageConfig.userCloseStreaming){PageConfig.streamingChannel="0";$j("#openStreaming").hide();$j("#lmtOpenStreaming").hide()}}FullMarketUtil.updateFullMarket(r,F,o,t,h,m,G);if(EventType.ELECTION.unique()==o||EventType.FANCYBET.unique()==o){var E=$j("#centerColumn");E.find("#fullMarketBetsWrap").hide();E.find("#gameMatchedName").hide();E.find("#gameMatched").hide();E.find("#gameHead").find("#multiMarketPin").hide()}if(PageConfig.ENABLE_JOCKEY_COLOR){if(EventType.GREYHOUND_RACING.unique()==o){r.find("#fullMarketBoard").removeClass("bets").addClass("bets-GH")}var l=m.selections;if(l==null||l.length==0||l[0]==null||l[0].runnerMetadata==null){return}FullMarketViewHandler.getFullMarketsTask.isGetRunnerMetadata=false;try{var u=JSON.parse(l[0].runnerMetadata);if(u!=null){r.find("#fullMarketBoard").removeClass("bets").addClass("bets-HS")}}catch(C){Trace.log(C)}}};function c(e,g){var f=e.find("#scoresEvent");f.html(g.marketName+'<img src="/images/transparent.gif">')}FullMarketViewHandler.getFullMarkets=function(){if(PageConfig.selectEventId==-1||PageConfig.selectMarketId==null){return}$j.ajax({type:"POST",dataType:"JSON",url:PageConfig.queryFullMarketsPath,data:{eventId:PageConfig.selectEventId,marketId:PageConfig.selectMarketId,selectionTs:-1},success:function(f){try{JsCache.get("#loading").hide();if(PageConfig.selectEventType==-1&&PageConfig.selectEventId==f.eventId&&PageConfig.selectMarketId==f.marketId){PageConfig.selectEventType=f.eventType}if(f.market!=null){DataBase.markets.update(f.market.eventId,[f.market])}FullMarketViewHandler.updateFullMarkets(f)}catch(g){Trace.printStackTrace(g)}finally{}},error:function(){}})};FullMarketViewHandler.changeToNextOpenRacingMarket=function(){$j.ajax({type:"POST",dataType:"JSON",url:PageConfig.queryMarketsWithoutSelectionPath,data:{eventType:PageConfig.selectEventType,eventId:PageConfig.selectEventId},success:function(f){try{DataBase.markets.update(f.eventId,f.markets);var g=a(f.markets);if(g!=null&&g.marketId!=null){PageConfig.selectMarketId=g.marketId;location.href=PageConfig.fullMarketPath+"?eventType="+PageConfig.selectEventType+"&eventId="+PageConfig.selectEventId+"&marketId="+g.marketId;NavigationHandler.clickNextOpenRacingEvent(PageConfig.selectEventId,g.marketId,g.marketDateTime)}else{MessageUtils.showThenGoToIndex("event is closed");return}}catch(h){Trace.printStackTrace(h)}finally{}},error:function(){}})};function a(e){var f=e.sort(function(i,h){if(MarketUtil.isClosed(i.status)){return 1}if(MarketUtil.isClosed(h.status)){return -1}if(i.marketType=="WIN"&&h.marketType=="WIN"){return i.marketTime.localeCompare(h.marketTime)}if(i.marketType=="WIN"){return -1}if(h.marketType=="WIN"){return 1}return i.marketTime.localeCompare(h.marketTime)});var g=f[0];if(MarketUtil.isOpen(g.status)){return g}return null}function d(h){var f=$j("#gameHead");if(PageConfig.hasLiveMatchTracker){f=$j("#liveMatchGameHead")}var e=f.find("#minMaxBox");if(h.betLimitSetting==null||h.betLimitSetting.length==0){e.hide();return}var g=h.betLimitSetting;e.find("#minMaxInfo").html(MathUtil.roundp(g.minBet,2)+" / "+MathUtil.roundp(g.maxBet,2));e.show()}})();